{"pageProps":{"postData":{"id":"asynchronous-action-creators-in-redux","href":{"pathname":"/blog/[year]/[month]/[day]/[slug]","query":{"year":"2016","month":"11","day":"10","slug":"asynchronous-action-creators-in-redux"}},"person":{"name":"Niall Wingham","title":"Apsis Alum","current":false,"image":"/img/people/niall.jpg","bio":"Niall is a cheerful curmudgeon and likes reading language and\nprotocol specifications. He lives with his professorial wife\nand pint-sized daughter in Toronto, and is by default the head\nof the Canadian branch of Apsis. When he grows up he wants to\nbe a farmer, or maybe a ballet dancer, or no, wait, a sailor!\n","bio_short":"Niall is a cheerful curmudgeon and likes reading language and\nprotocol specifications. He lives with his professorial wife\nand pint-sized daughter in Toronto, and is by default the head\nof the Canadian branch of Apsis. When he grows up he wants to\nbe a farmer, or maybe a ballet dancer, or no, wait, a sailor!\n"},"desc":"Improving the logic-to-boilerplate ratio of asynchronous action definitions.","contentHtml":"<p>Redux applications often use the <a href=\"https://github.com/gaearon/redux-thunk\">redux-thunk</a> middleware to dispatch actions for interacting with an HTTP API.  A pattern for asynchronous action creators is demonstrated in the <a href=\"http://redux.js.org/docs/advanced/AsyncActions.html\">documentation</a> as follows (adding the error catching logic it recommends for a real-world application):</p>\n<pre><code class=\"hljs language-javascript\"><span class=\"hljs-keyword\">export</span> <span class=\"hljs-keyword\">const</span> <span class=\"hljs-variable constant_\">REQUEST_POSTS</span> = <span class=\"hljs-string\">&#x27;REQUEST_POSTS&#x27;</span>\n<span class=\"hljs-keyword\">function</span> <span class=\"hljs-title function_\">requestPosts</span>(<span class=\"hljs-params\">subreddit</span>) {\n    <span class=\"hljs-keyword\">return</span> {\n        <span class=\"hljs-attr\">type</span>: <span class=\"hljs-variable constant_\">REQUEST_POSTS</span>,\n        subreddit\n    }\n}\n\n<span class=\"hljs-keyword\">export</span> <span class=\"hljs-keyword\">const</span> <span class=\"hljs-variable constant_\">RECEIVE_POSTS</span> = <span class=\"hljs-string\">&#x27;RECEIVE_POSTS&#x27;</span>\n<span class=\"hljs-keyword\">function</span> <span class=\"hljs-title function_\">receivePosts</span>(<span class=\"hljs-params\">subreddit, json</span>) {\n    <span class=\"hljs-keyword\">return</span> {\n        <span class=\"hljs-attr\">type</span>: <span class=\"hljs-variable constant_\">RECEIVE_POSTS</span>,\n        subreddit,\n        <span class=\"hljs-attr\">posts</span>: json.<span class=\"hljs-property\">data</span>.<span class=\"hljs-property\">children</span>.<span class=\"hljs-title function_\">map</span>(<span class=\"hljs-function\"><span class=\"hljs-params\">child</span> =&gt;</span> child.<span class=\"hljs-property\">data</span>),\n        <span class=\"hljs-attr\">receivedAt</span>: <span class=\"hljs-title class_\">Date</span>.<span class=\"hljs-title function_\">now</span>()\n    }\n}\n\n<span class=\"hljs-keyword\">export</span> <span class=\"hljs-keyword\">const</span> <span class=\"hljs-variable constant_\">RECEIVE_POSTS_ERROR</span> = <span class=\"hljs-string\">&#x27;RECEIVE_POSTS_ERROR&#x27;</span>\n<span class=\"hljs-keyword\">function</span> <span class=\"hljs-title function_\">receivePostsError</span>(<span class=\"hljs-params\">subreddit, error</span>) {\n    <span class=\"hljs-keyword\">return</span> {\n        <span class=\"hljs-attr\">type</span>: <span class=\"hljs-variable constant_\">RECEIVE_POSTS_ERROR</span>,\n        subreddit,\n        error\n    }\n}\n\n<span class=\"hljs-keyword\">export</span> <span class=\"hljs-keyword\">function</span> <span class=\"hljs-title function_\">fetchPosts</span>(<span class=\"hljs-params\">subreddit</span>) {\n    <span class=\"hljs-keyword\">return</span> <span class=\"hljs-keyword\">function</span> (<span class=\"hljs-params\">dispatch</span>) {\n        <span class=\"hljs-title function_\">dispatch</span>(<span class=\"hljs-title function_\">requestPosts</span>(subreddit))\n        <span class=\"hljs-keyword\">return</span> <span class=\"hljs-title function_\">fetch</span>(<span class=\"hljs-string\">`http://www.reddit.com/r/<span class=\"hljs-subst\">${subreddit}</span>.json`</span>)\n            .<span class=\"hljs-title function_\">then</span>(<span class=\"hljs-function\"><span class=\"hljs-params\">response</span> =&gt;</span> response.<span class=\"hljs-title function_\">json</span>())\n            .<span class=\"hljs-title function_\">then</span>(<span class=\"hljs-function\"><span class=\"hljs-params\">json</span> =&gt;</span> <span class=\"hljs-title function_\">dispatch</span>(<span class=\"hljs-title function_\">receivePosts</span>(subreddit, json)))\n            .<span class=\"hljs-title function_\">catch</span>(<span class=\"hljs-function\"><span class=\"hljs-params\">error</span> =&gt;</span> <span class=\"hljs-title function_\">dispatch</span>(<span class=\"hljs-title function_\">receivePostsError</span>(subreddit, error)))\n    }\n}\n</code></pre><p>This is a simple pattern to follow, but it&#8217;s a lot of code to write for the little bit of logic contained here.  Even worse, that logic is separated into two non-adjacent blocks which appear out of order of their execution.<sup><a id=\"footnote-ref-1\" href=\"#footnote-1\" data-footnote-ref aria-describedby=\"footnote-label\">1</a></sup></p>\n<pre><code class=\"hljs language-javascript\"><span class=\"hljs-attr\">posts</span>: json.<span class=\"hljs-property\">data</span>.<span class=\"hljs-property\">children</span>.<span class=\"hljs-title function_\">map</span>(<span class=\"hljs-function\"><span class=\"hljs-params\">child</span> =&gt;</span> child.<span class=\"hljs-property\">data</span>),\n<span class=\"hljs-attr\">receivedAt</span>: <span class=\"hljs-title class_\">Date</span>.<span class=\"hljs-title function_\">now</span>()\n\n...\n\n<span class=\"hljs-title function_\">fetch</span>(<span class=\"hljs-string\">`http://www.reddit.com/r/<span class=\"hljs-subst\">${subreddit}</span>.json`</span>)\n    .<span class=\"hljs-title function_\">then</span>(<span class=\"hljs-function\"><span class=\"hljs-params\">response</span> =&gt;</span> response.<span class=\"hljs-title function_\">json</span>())\n</code></pre><p>I generally favour simple repetitive code over complex succinct code.  But if your application were to implement this for every API call it made, the typographical burden could prove too great to bear!</p>\n<p>Let&#8217;s see if we can improve the signal-to-noise (i.e. logic-to-boilerplate) ratio of this action definition without introducing any new dependencies or abstractions.<sup><a id=\"footnote-ref-2\" href=\"#footnote-2\" data-footnote-ref aria-describedby=\"footnote-label\">2</a></sup></p>\n<p>Here is the common structure I see in the pattern:</p>\n<ol>\n<li><p>Every asynchronous action is going to dispatch three types of synchronous actions corresponding to the <code>pending</code>, <code>fulfilled</code>, and <code>rejected</code> state of a promise.  These are the actions that will actually be handled by a reducer.</p>\n</li>\n<li><p>The asynchronous action creator will have to accept some number of arguments in order to create the promise&#8212;in this example, it was just the name of the subreddit&#8212;and these arguments should also passed along to the reducer as part of the action object.</p>\n</li>\n<li><p>The promise is returned to the code calling dispatch, in case it needs to chain some logic of its own.</p>\n</li>\n</ol>\n<p>Those observations lead us to a helper function&#8212;I suppose you could call it an asynchronous action creator <em>creator</em>&#8212;that looks like this:</p>\n<pre><code class=\"hljs language-javascript\"><span class=\"hljs-keyword\">export</span> <span class=\"hljs-keyword\">default</span> <span class=\"hljs-keyword\">function</span> <span class=\"hljs-title function_\">promiseAction</span>(<span class=\"hljs-params\">type, createPromise</span>) {\n    <span class=\"hljs-keyword\">const</span> actionTypes = {\n        <span class=\"hljs-attr\">START</span>: type + <span class=\"hljs-string\">&#x27;_START&#x27;</span>,\n        <span class=\"hljs-attr\">SUCCESS</span>: type + <span class=\"hljs-string\">&#x27;_SUCCESS&#x27;</span>,\n        <span class=\"hljs-attr\">ERROR</span>: type + <span class=\"hljs-string\">&#x27;_ERROR&#x27;</span>\n    }\n\n    <span class=\"hljs-keyword\">const</span> <span class=\"hljs-title function_\">actionCreator</span> = args =&gt; <span class=\"hljs-function\">(<span class=\"hljs-params\">dispatch, getState</span>) =&gt;</span> {\n        <span class=\"hljs-title function_\">dispatch</span>({ <span class=\"hljs-attr\">type</span>: actionTypes.<span class=\"hljs-property\">START</span>, ...args })\n        <span class=\"hljs-keyword\">return</span> <span class=\"hljs-title function_\">createPromise</span>({ <span class=\"hljs-attr\">state</span>: <span class=\"hljs-title function_\">getState</span>(), ...args }).<span class=\"hljs-title function_\">then</span>(\n            <span class=\"hljs-function\"><span class=\"hljs-params\">result</span> =&gt;</span> <span class=\"hljs-title function_\">dispatch</span>({ <span class=\"hljs-attr\">type</span>: actionTypes.<span class=\"hljs-property\">SUCCESS</span>, result, ...args }),\n            <span class=\"hljs-function\"><span class=\"hljs-params\">error</span> =&gt;</span> <span class=\"hljs-title function_\">dispatch</span>({ <span class=\"hljs-attr\">type</span>: actionTypes.<span class=\"hljs-property\">ERROR</span>, error, ...args })\n        )\n    }\n\n    <span class=\"hljs-keyword\">return</span> [actionTypes, actionCreator]\n}\n</code></pre><p>Now the action definition from the example can be written with almost no boilerplate:</p>\n<pre><code class=\"hljs language-javascript\"><span class=\"hljs-keyword\">export</span> <span class=\"hljs-keyword\">const</span> [<span class=\"hljs-variable constant_\">FETCH_POSTS</span>, fetchPosts] = <span class=\"hljs-title function_\">promiseAction</span>(<span class=\"hljs-string\">&#x27;FETCH_POSTS&#x27;</span>, <span class=\"hljs-function\">(<span class=\"hljs-params\">{ subreddit }</span>) =&gt;</span> {\n    <span class=\"hljs-keyword\">return</span> <span class=\"hljs-title function_\">fetch</span>(<span class=\"hljs-string\">`http://www.reddit.com/r/<span class=\"hljs-subst\">${subreddit}</span>.json`</span>)\n        .<span class=\"hljs-title function_\">then</span>(<span class=\"hljs-function\"><span class=\"hljs-params\">response</span> =&gt;</span> response.<span class=\"hljs-title function_\">json</span>())\n        .<span class=\"hljs-title function_\">then</span>(<span class=\"hljs-function\"><span class=\"hljs-params\">json</span> =&gt;</span> ({\n            <span class=\"hljs-attr\">posts</span>: json.<span class=\"hljs-property\">data</span>.<span class=\"hljs-property\">children</span>.<span class=\"hljs-title function_\">map</span>(<span class=\"hljs-function\"><span class=\"hljs-params\">child</span> =&gt;</span> child.<span class=\"hljs-property\">data</span>),\n            <span class=\"hljs-attr\">receivedAt</span>: <span class=\"hljs-title class_\">Date</span>.<span class=\"hljs-title function_\">now</span>()\n        }))\n})\n</code></pre><p>A few notes on the implementation:</p>\n<ol>\n<li><p>We pass the state into the promise creator.  This makes it possible to implement logic like executing an HTTP request only if the resource hasn&#8217;t already been loaded (see the subsequent <code>fetchPostsIfNeeded</code> example from the redux docs) without creating an additional thunk.</p>\n</li>\n<li><p>The asynchronous action creator is called with object-style arguments rather than an argument list, so they can be passed along as named properties of the synchronous action objects.  Calling code looks like <code>dispatch(createPost({ author, content }))</code>  instead of <code>dispatch(createPost(author, content))</code></p>\n</li>\n<li><p>We export the three action types as a single object with <code>START</code>, <code>SUCCESS</code>, and <code>ERROR</code> properties instead of exporting three separate strings.  This is really just to have shorter import statements in the reducer.</p>\n</li>\n</ol>\n<p>I like this kind of helper because it makes our code less repetitive while keeping the simplicity of the original.  No new dependencies are added, no new abstractions need to be learned; we just extract a pattern which was already present.</p>\n<section class=\"footnotes\" data-footnotes>\n<h2 id=\"footnote-label\" class=\"sr-only\">Footnotes</h2>\n<ol>\n<li id=\"footnote-1\">\n<p>Of course, you can&#8217;t always write code in order of execution, but when you have a few statements like: parse this JSON, then extract these properties, then set a timestamp; <em>which are always executed together and in that order,</em> it seems silly not to. <a href=\"#footnote-ref-1\" data-footnote-backref aria-label=\"Back to reference 1\">↩</a></p>\n</li>\n<li id=\"footnote-2\">\n<p>If you are willing to increase complexity, there are certainly dependencies that you can introduce!  For example, <a href=\"https://github.com/acdlite/redux-promise\">redux-promise</a> and <a href=\"https://github.com/pburtchaell/redux-promise-middleware\">redux-promise-middleware</a> each implement middleware that allow you to dispatch promises directly.  They also use <a href=\"https://github.com/acdlite/flux-standard-action\">flux standard actions</a>, so that&#8217;s another small standard you&#8217;ll need to learn.  You may be disappointed if their choice of abstraction does not line up with what you need.  redux-promise does not dispatch a starting action so you&#8217;ll probably end up using it in combination with redux-thunk.  redux-promise-middleware has gone through four major versions, changing its interface a bit each time.  Neither exposes application state. <a href=\"#footnote-ref-2\" data-footnote-backref aria-label=\"Back to reference 2\">↩</a></p>\n</li>\n</ol>\n</section>\n","author":"niall","layout":"post","title":"Asynchronous Action Creators in Redux","image":"/img/posts/clocke.jpg","excerpt":"<p>Improving the logic-to-boilerplate ratio of asynchronous action definitions.</p>\n","date":"2016-11-10"},"cta":{"title":"You're busy","subtitle":"Give us a shout &mdash; we can help","button":"Let's talk"}},"__N_SSG":true}