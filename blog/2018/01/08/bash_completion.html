<!doctype html>
<html>
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=0">
    <title>Apsis Labs | Save Time with Bash Programmable Autocompletion</title>
    <!-- !START meta -->
    <meta name="description" content="What follows is a short tutorial on bash autocompletion and a tiny bit of bash programming information. It assumes you have a working knowledge of programmin...">
    <link rel="canonical" href="/blog/2018/01/08/bash_completion">
    <link rel="alternate" type="application/rss+xml" title="Development Chop Shop" href="/feed.xml">
    <meta content="Apsis Labs" property="og:site_name">
    <meta content="Save Time with Bash Programmable Autocompletion" property="og:title">
    <meta content="article" property="og:type">
    <meta content="What follows is a short tutorial on bash autocompletion and a tiny bit of bash programming information. It assumes you have a working knowledge of programmin..." property="og:description">
    <meta content="/blog/2018/01/08/bash_completion" property="og:url">
    <meta content="2018-01-08T00:00:00+00:00" property="article:published_time">
    <meta content="/assets/posts/bash.gif" property="og:image">
    <!-- !END meta -->
    <!-- !START favicons -->
    <link rel="apple-touch-icon" sizes="57x57" href="/assets/favicons/apple-icon-57x57.png">
    <link rel="apple-touch-icon" sizes="60x60" href="/assets/favicons/apple-icon-60x60.png">
    <link rel="apple-touch-icon" sizes="72x72" href="/assets/favicons/apple-icon-72x72.png">
    <link rel="apple-touch-icon" sizes="76x76" href="/assets/favicons/apple-icon-76x76.png">
    <link rel="apple-touch-icon" sizes="114x114" href="/assets/favicons/apple-icon-114x114.png">
    <link rel="apple-touch-icon" sizes="120x120" href="/assets/favicons/apple-icon-120x120.png">
    <link rel="apple-touch-icon" sizes="144x144" href="/assets/favicons/apple-icon-144x144.png">
    <link rel="apple-touch-icon" sizes="152x152" href="/assets/favicons/apple-icon-152x152.png">
    <link rel="apple-touch-icon" sizes="180x180" href="/assets/favicons/apple-icon-180x180.png">
    <link rel="icon" type="image/png" sizes="192x192"  href="/assets/favicons/android-icon-192x192.png">
    <link rel="icon" type="image/png" sizes="32x32" href="/assets/favicons/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="96x96" href="/assets/favicons/favicon-96x96.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/assets/favicons/favicon-16x16.png">
    <link rel="icon" type="image/png" href="/assets/favicons/favicon.ico">
    <!-- !END favicons -->
    <!-- !START polyfill -->
    <!--[if lt IE 9]>
      <script type="text/javascript" src="/assets/vendor/html5shiv.min.js"></script>
      <script type="text/javascript" src="/assets/vendor/html5shiv-printshiv.min.js"></script>
    <![endif]-->
    <script type="text/javascript" src="/assets/polyfill.js" async="async"></script>
    <!-- !END polyfill -->
    <!-- !START styles -->
    <link type="text/css" rel="stylesheet" href="/assets/app.css">
    <!-- !END styles -->
  </head>
  <body class="">
    <!-- !START navbar -->
    <header id="navbar" class="navbar ">
      <div class="navbar__header">
        <a href="/" class="logo logo--navbar logo--mobile navbar__logo">
          <picture>
            <source media="(min-width: 960px)" srcset="/assets/logos/apsis_blue.png" />
            <source srcset="/assets/logos/apsis_mobile_blue.png" />
            <img src="/assets/logos/apsis_blue.png" alt="Apsis Labs" class="logo__image">
          </picture>
          <h1 class="logo__text">Apsis Labs</h1>
        </a>
        <button id="nav-toggle" class="navbar__nav-toggle">
          <span class="navicon ">
            <span class="navicon__bar"></span>
          </span>
          <span class="sr">Toggle Menu</span>
        </button>
      </div>
      <nav class="navbar__nav">
        <a class="navbar__nav-link" href="/#services">Services</a>
        <a class="navbar__nav-link" href="/#about">About</a>
        <a class="navbar__nav-link" href="/#clients">Clients</a>
        <a class="navbar__nav-link" href="/#contact">Contact</a>
        <a class="navbar__nav-link" href="/jobs/">Jobs</a>
        <a class="navbar__nav-link" href="/blog/">Blog</a>
      </nav>
    </header>
    <!-- !END navbar -->
    <!-- !START content -->
    <div id="content">
      <!-- !START schema.org -->
      <script type="application/ld+json">
        {
            "@context": "http://schema.org",
            "@type": "BlogPosting",
            "headline": "Save Time with Bash Programmable Autocompletion",
            "datePublished": "2018-01-08 00:00:00 +0000",
            "dateModified": "2018-01-08 00:00:00 +0000",
            "author": {
              "@type": "Person",
              "name": "Chris Pfohl"
            },
            "publisher": {
              "@type": "Organization",
              "name": "Apsis Labs",
              "logo": "/assets/logos/apsis_blue.png"
            },
            "mainEntityOfPage": {
              "@type": "WebPage",
              "@id": "/blog/2018/01/08/bash_completion"
            },
        
              "image": ["/assets/posts/bash.gif"]
        
          }
      </script>
      <!-- !END schema.org -->
      <div class="post-wrapper post-wrapper--single">
        <div class="container">
          <article class="post">
            <header class="post__header">
              <div class="post__image-wrapper">
                <img src="/assets/posts/bash.gif" alt="Save Time with Bash Programmable Autocompletion. " class="post__image" data-action="zoom">
              </div>
              <h2 class="post__title" itemprop="name headline">
                <a href="">
                  Save Time with Bash Programmable Autocompletion
        </a>
              </h2>
            </header>
            <div class="post__content">
              <p>Every developer should have at least a basic mastery of their command line. I&rsquo;d argue
that part of that mastery is to develop a set of customizations they take with them
wherever they go. These customizations should make things you do all the time faster.
Obviously there are diminshing returns here<sup id="fnref1"><a href="#fn1" rel="footnote">1</a></sup>.</p>
              <p>Some of my customizations include bash aliases for my most used git commands. <code>ga</code> is
short for <code>git add</code>, <code>gap</code> is short for <code>git add -p</code>, etc. I also like to have a
syntax highlighted <code>cat</code> and <code>less</code> available to me using <a href="http://pygments.org/">Pygments</a>.</p>
              <p>Today I added something I&rsquo;ve wanted for a long time: a <code>cd</code> that works relative to
the directory I do most of my development work in. Now I can run <code>cdx subdir_of_x</code>
                and it will take me to <code>~/x/subdir_of_x</code>.</p>
              <p>You may be wondering &ldquo;Why use precious kilobytes of storage and hours of time writing
this up!?&rdquo; And you&rsquo;d be corect. By itself, this is not worthy of a blog post.
I, however, also added autocompletion for the contents of that directory, and <em>that</em>
                is worth writing about.</p>
              <p>What follows is a short tutorial on bash autocompletion and a tiny bit of bash programming
information. It assumes you have a working knowledge of programming, and at least passing
familiarity with your terminal.</p>
              <h2>The Function</h2>
              <p>In and of itself, this a very easy function<sup id="fnref2"><a href="#fn2" rel="footnote">2</a></sup> to write. In your <code>~/.bashrc</code> add:</p>
              <div class="highlight">
                <pre><code class="language-" data-lang="">function cdx {
    cd "$HOME/x/$1"
}
</code></pre>
              </div>
              <p>My first test looked like this:</p>
              <div class="highlight">
                <pre><code class="language-" data-lang="">cdx my_code  &lt;TAB&gt;  _base
</code></pre>
              </div>
              <p>No autocomplete, just big gaping tabs in the middle of my command. What&rsquo;s an enterprising
developer<sup id="fnref3"><a href="#fn3" rel="footnote">3</a></sup> to do? Spend the morning figuring it out, of course.</p>
              <h2>The Code</h2>
              <p>First, the good stuff. All together, when placed in your <code>~/.bashrc</code> and <code>source</code>ed,
the following works for hypothetical directory <code>x</code> in your home directory using the new
command <code>cdx</code>:</p>
              <div class="highlight">
                <pre><code class="language-" data-lang="">function cdx {
    cd "$HOME/x/$1"
}
function _cdx {
    local cur opts

    opts="$(ls -1 ~/x)"
    cur="${COMP_WORDS[COMP_CWORD]}"

    COMPREPLY=( $(compgen -W "${opts}" -- ${cur}) )
    return 0
}
complete -F _cdx cdx
</code></pre>
              </div>
              <p>To make it work:</p>
              <ol>
                <li>Insert this in <code>~/.bashrc</code>.</li>
                <li>Replace all instances of &ldquo;x&rdquo; with a directory from your <code>$HOME</code> directory.</li>
                <li>Call <code>source ~/.bashrc</code>.</li>
              </ol>
              <p>You may want to rename <code>cdx</code> with a more intuitive name (for Apsis code, for example,
I&rsquo;d use <code>cda</code> and <code>_cda</code>).</p>
              <h2>The Explanation</h2>
              <p>Now to break the <code>_cdx</code> function down. When it gets obvious feel free to skip to the end, I&rsquo;ve
attempted to order this from most specific to broadest bash knowledge. (In order of <em>my</em> current
knowledge of bash). I&rsquo;ve left the most basic stuff (like explaining <code>ls</code>) out.</p>
              <ol>
                <li>
                  <p><code>complete -F _cdx cdx</code> is how you let bash know to attempt an autocomplete. In English it&rsquo;s:</p>
                  <blockquote>
                    <p>When I run the cdx command please use the function _cdx to autocomplete the command.</p>
                  </blockquote>
                </li>
                <li>
                  <p><code>compgen -W &quot;${opts}&quot; -- ${cur}</code> is the function that searches an array of possibilities (<code>-W</code>)
for the text after <code>--</code>. It&rsquo;s pretty rigid: no fuzzy searching, no autocorrecting. It just returns
&ldquo;things from the array that start with what you typed.&rdquo; You are free to replace it with
whatever you want as long as it too returns an array (space separated string) of the options.
In English:</p>
                  <blockquote>
                    <p>Please give me all the words in the string &lsquo;opts&rsquo; that start with what&rsquo;s in &#39;cur&rsquo;.</p>
                  </blockquote>
                </li>
                <li>
                  <p><code>COMPREPLY</code> is basically the return value of this function. Whatever array you return here will be
presented to you on the command line as options for autocompletion. In English:</p>
                  <blockquote>
                    <p>Here&rsquo;s what I want to pick from when autocompleting with the current inputs.</p>
                  </blockquote>
                </li>
                <li>
                  <p><code>cur=&quot;${COMP_WORDS[COMP_CWORD]}&quot;</code> is setting <code>cur</code> to the last word on the command line. <code>COMP_WORDS</code>
                    and <code>COMP_CWORD</code> are the inputs to this function. (You can actually make them real bash function
parameters if you want to, but they&rsquo;re already acceptably named). They are special bash variables
that are only available in completion functions. <code>COMP_WORDS</code> is the array of strings currently
entered on the command line. <code>COMP_CWORDS</code> is the current length of the <code>COMP_WORDS</code> array. In English:</p>
                  <blockquote>
                    <p>Set the variable &#39;cur&rsquo; to the last word on the command line.</p>
                  </blockquote>
                </li>
                <li>
                  <p><code>opts=&quot;$(ls -1 ~/x)&quot;</code> is where we set the available options by creating an array (space separated string)
from the output of <code>ls -1 ~/x</code>. This gets used in the <code>compgen</code> command. In English:</p>
                  <blockquote>
                    <p>Set &ldquo;opts&rdquo; to the output of &ldquo;ls -1 ~/x&rdquo; as the list of potential options to autocomplete from.</p>
                  </blockquote>
                </li>
                <li>
                  <p><code>local cur opts</code> is a declaration of the cur and opts variables. By using <code>local</code> we avoid cluttering
the global variable namespace. In English:</p>
                  <blockquote>
                    <p>I&rsquo;m going to use the cur and opts variables. You can forget them when this function ends.</p>
                  </blockquote>
                </li>
                <li>
                  <p><code>return 0</code> quits the function and sets the bash exit code. <code>0</code> is success, all other values are failures.
This is useful in other bash scripts when you want to use it with <code>&amp;&amp;</code> <code>||</code>. Here it simply informs bash
that the completion script was successful. In English:</p>
                  <blockquote>
                    <p>IT WORKED! Show the user the values in &ldquo;COMPREPLY&rdquo;!</p>
                  </blockquote>
                </li>
              </ol>
              <h2>Improvements</h2>
              <p>This is a great start, and super useful as is, but there is more that could be done:</p>
              <ol>
                <li>
                  <p>Going deeper: it&rsquo;d be nice if I could keep autocompleting deeper into the directory, so <code>cdx ydir/zdi</code>
                    could autocomplete to <code>~/x/ydir/zdir</code>. This would involve making the <code>opts=</code> line more intelligent.</p>
                </li>
                <li>
                  <p>Fuzzy searching: I am great at typos. It&rsquo;d be nice if I could replace <code>compgen</code> with something more
intelligent that will ignore small typos.</p>
                </li>
                <li>
                  <p>More generic: Being able to match <code>cda</code> or <code>cdb</code> to switch to subdirectories of <code>~/apsis</code> or <code>~/bread</code>
                    would be nice. Writing a script to handle the unique cases when bash fires up would be easily doable.
It would, however, require separate autocomplete functions for each named function becuase <code>complete</code>
                    only accepts literal command names.</p>
                </li>
              </ol>
              <h2>Troubleshooting/Further Reading</h2>
              <p>If the above doesn&rsquo;t work it&rsquo;s possible your <code>progcomp</code> bash option isn&rsquo;t set. You can check with:</p>
              <p><code>echo $BASHOPTS | grep -q progcomp &amp;&amp; echo &quot;YES&quot; || echo &quot;NO&quot;</code></p>
              <p>By default it&rsquo;s set, but if for whatever reason it&rsquo;s not, and you didn&rsquo;t knowingly do it yourself, you can set it
with <code>shopt -s progcomp</code>. That can be added to your <code>.bashrc</code>.</p>
              <p>If that&rsquo;s not the problem, you will have to debug this the old fashioned way. Use <code>echo &quot;$VARNAME&quot;</code> to see the values
of variables. Finally you may want to read the docs.</p>
              <p>I didn&rsquo;t initially suggest reading the docs because, unfortunately, the documentation for anything contained in the
bash man pages is terribly undiscoverable, difficult to search, and not always easy to read <sup id="fnref4"><a href="#fn4" rel="footnote">4</a></sup>. All of the above
is in the bash man pages. Here&rsquo;s how you can find the relevant docs:</p>
              <ul>
                <li><code>man bash</code> to open the documentation for bash itself.</li>
                <li>Press <code>/</code> to start searching.</li>
                <li>Once you&rsquo;ve entered your search term hit &ldquo;Enter&rdquo; and then use <code>n</code> and <code>N</code> to search forward and backwards
(respectively) for the content you want.</li>
                <li>You&rsquo;ll want the following search terms:

                  <ul>
                    <li>&ldquo;Programming Completion&rdquo; for an overview of completion in bash.</li>
                    <li>&ldquo;compgen&rdquo; for the function that we use to match input with the search term.</li>
                    <li>&ldquo;complete&rdquo; for the function used to tell bash to use programmable completion for a given command.</li>
                  </ul>
                </li>
              </ul>
              <p>Update: After completing my first draft of this post, Niall pointed me to the far more readable and digestible <a href="http://www.tldp.org/LDP/abs/html/tabexpansion.html">TLDP</a>.</p>
              <h2>In Closing</h2>
              <p>Bash Programmable Autocompletion is powerful, but intimidating at first. Hopefully this post helps you get started.
If you build something awesome write it up and ping us on twitter! We&rsquo;re <a href="https://twitter.com/apsislabs">@ApsisLabs</a>.</p>
              <div class="footnotes">
                <hr>
                <ol>
                  <li id="fn1">
                    <p><a href="https://xkcd.com/1205/">xkcd is relevant here</a>&nbsp;<a href="#fnref1" rev="footnote">&#8617;</a></p>
                  </li>
                  <li id="fn2">
                    <p>Couldn&rsquo;t use an alias, because aliases can&rsquo;t interpolate arguments, they&rsquo;re strictly dumb text replacements , and they always include a space at the end.&nbsp;<a href="#fnref2" rev="footnote">&#8617;</a></p>
                  </li>
                  <li id="fn3">
                    <p>One with a head cold, limited exposure to bash internals like autocomplete, and more important work to accomplish.&nbsp;<a href="#fnref3" rev="footnote">&#8617;</a></p>
                  </li>
                  <li id="fn4">
                    <p>Man pages, as useful as they are, are dinosaurs <a href="https://unix.stackexchange.com/a/18161/34182">from a prehistoric time before hypertext was invented</a>. You can&rsquo;t follow bolded text as if they were links.&nbsp;<a href="#fnref4" rev="footnote">&#8617;</a></p>
                  </li>
                </ol>
              </div>
            </div>
            <aside class="author-block">
              <img src="/assets/people/chris.jpg" alt="Chris Pfohl" class="author-block__image">
              <header class="author-block__header">
                <h5 class="author-block__title">Chris Pfohl</h5>
              </header>
              <div class="author-block__content">
                <p>Chris accidentally became a software developer when he realized how much he enjoyed his first programming class in college. He&rsquo;s never written a tetris clone in Q-Basic, and to date has never created a todo app or twitter clone. When he&rsquo;s not working he&rsquo;s most likely roasting coffee, brewing beer, or playing a board game.</p>
              </div>
            </aside>
          </article>
        </div>
      </div>
    </div>
    <!-- !END content -->
    <!-- !START footer -->
    <footer id="footer" class="site-footer">
      <div class="container">
        <small>
          &copy; 2021 apsis labs
            |
            shuttle image credit NASA
        </small>
      </div>
    </footer>
    <!-- !END footer -->
    <!-- !START javascript includes -->
    <script type="text/javascript" src="/assets/vendor.js"></script>
    <script type="text/javascript" src="/assets/scripts.js"></script>
    <!-- !END javascript includes -->
    <!-- !START Google Analytics -->
    <script>
      (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
                  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
                  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
                  })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
      
                  ga('create', 'UA-47858702-1', 'auto');
                  ga('send', 'pageview');
    </script>
    <!-- !END Google Analytics -->
    <!-- !START google fonts -->
    <script type="text/javascript">
      WebFontConfig = {
              google: { families: [ 'Open+Sans:400,300,300italic,400italic,600,700,600italic,700italic:latin', 'Source+Code+Pro:400,500,600,700:latin', 'Lora:400,400italic,700,700italic:latin' ] }
          };
      
          (function() {
              var wf = document.createElement('script');
              wf.src = 'https://ajax.googleapis.com/ajax/libs/webfont/1/webfont.js';
              wf.type = 'text/javascript';
              wf.async = 'true';
              var s = document.getElementsByTagName('script')[0];
              s.parentNode.insertBefore(wf, s);
          })();
    </script>
    <!-- !END google fonts -->
  </body>
</html>